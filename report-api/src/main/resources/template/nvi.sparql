PREFIX : <https://nva.sikt.no/ontology/publication#>
PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>

SELECT DISTINCT
  ?publicationId
  ?contributorIdentifier
  ?affiliationId
  ?institutionId
  ?institutionPoints
  ?pointsForAffiliation
  ?institutionApprovalStatus
  ?globalApprovalStatus
  ?reportedPeriod
  ?totalPoints
  ?publicationTypeChannelLevelPoints
  ?authorShareCount
  ?internationalCollaborationFactor
  ?isApplicable
  ?modifiedDate
WHERE {
  GRAPH ?g {
    {
      ?candidate a :NviCandidate ;
        :modifiedDate ?modifiedDateRaw ;
        :publicationId ?publicationUri ;
        :isApplicable true ;
        :totalPoints ?totalPoints ;
        :globalApprovalStatus ?globalApprovalStatus ;
        :internationalCollaborationFactor ?internationalCollaborationFactorDecimal ;
        :creatorShareCount ?authorShareCount ;
        :publicationTypeChannelLevelPoints ?publicationTypeChannelLevelPointsDecimal ;
        :reportingYear ?reportingYear ;
        :reported ?reported ;
        :nviContributor ?nviContributor ;
        :approval ?approval .

      FILTER(?modifiedDateRaw >= "__AFTER__"^^xsd:dateTime)
      FILTER(?modifiedDateRaw < "__BEFORE__"^^xsd:dateTime)

      BIND(STR(?publicationUri) AS ?publicationId)
      BIND(STR(?modifiedDateRaw) AS ?modifiedDate)
      BIND(STR(?internationalCollaborationFactorDecimal) AS ?internationalCollaborationFactor)
      BIND(STR(?publicationTypeChannelLevelPointsDecimal) AS ?publicationTypeChannelLevelPoints)

      BIND(IF(?reported = true, ?reportingYear, "NotReported") AS ?reportedPeriod)

      BIND("true" AS ?isApplicable)

      BIND(STR(?nviContributor) AS ?contributorIdString)
      BIND(REPLACE(STR(?nviContributor), "^.*/([^/]*)$", "$1") AS ?contributorIdentifier)

      ?nviContributor :nviAffiliation ?affiliationUri .
      BIND(STR(?affiliationUri) AS ?affiliationId)

      ?approval :approvalStatus ?institutionApprovalStatus ;
                :institutionPoints ?institutionPoints ;
                :creatorAffiliationPoints ?creatorAffiliationPoints ;
                :institutionId ?organizationUri ;
                :involvedOrganization ?affiliationId .

      BIND(STR(?organizationUri) AS ?institutionId)

      ?creatorAffiliationPoints :nviCreator ?contributorIdString ;
                                :affiliation ?affiliationId ;
                                :points ?pointsForAffiliationDouble .

      BIND(STR(?pointsForAffiliationDouble) AS ?pointsForAffiliation)
    }
    UNION
    {
      ?candidate a :NviCandidate ;
        :modifiedDate ?modifiedDateRaw ;
        :publicationId ?publicationUri ;
        :isApplicable false .

      FILTER(?modifiedDateRaw >= "__AFTER__"^^xsd:dateTime)
      FILTER(?modifiedDateRaw < "__BEFORE__"^^xsd:dateTime)

      BIND(STR(?publicationUri) AS ?publicationId)
      BIND("false" AS ?isApplicable)
      BIND(STR(?modifiedDateRaw) AS ?modifiedDate)

    }
  }
} LIMIT __PAGE_SIZE__ OFFSET __OFFSET__